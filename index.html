<meta charset="utf8" />
<html>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.4.0/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite-api"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/vega-tooltip"></script>

         <script src="https://unpkg.com/deck.gl@~6.4/deckgl.min.js"></script>
         <script src="https://unpkg.com/@msrvida/vega-deck.gl@^2/dist/umd/vega-deck.gl.js"></script> -->

    <script>
     var config = {
         locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.4.0/dist/${filename}`
     }
     initSqlJs(config).then(function (SQL) {
         const dataPromise = fetch("https://rationalis.github.io/maplestory-starforce-calc/output.db").then(res => res.arrayBuffer());
         dataPromise.then((buf) => {
             const db = new SQL.Database(new Uint8Array(buf));
             var stmt = db.prepare("SELECT * FROM data");
             stmt.getAsObject({$start:1, $end:1}); // {col1:1, col2:111}

             var data = [];
             // Bind new values
             stmt.bind({$start:1, $end:2});
             while(stmt.step()) { //
                 var row = stmt.getAsObject();
                 data.push(row);
             }

             const index = vl.selectSingle()
                             .on('mousemove')
                             .resolve('intersect');

             const plot = vl.markBar()
                            .autosize('fit')
                            .width('container')
                            .height('container')
                            .encode(
                                vl.x().fieldQ("cost").bin({maxbins: 100}).title("Meso Cost"),
                                vl.y().fieldQ("prob").aggregate("sum").title("Probability"),
                                vl.tooltip([
                                    {field: "cost", type: "quantitative", bin: {maxbins: 100}, format: ".3s"},
                                    {field: "prob", type: "quantitative", aggregate: "sum", format: ".2%", "title": "Probability"},
                                ]),
                            )

             const plot_brush = plot.encode(vl.opacity(vl.value(0.5)))
                                    .params([{
                                        "name": "brush",
                                        "select": {"type": "point", "encodings": ["x"], "on": "mousemove", 'nearest': true, 'resolve': 'union'},
                                    }])

             const layers = vl
                 .layer(
                     plot_brush,
                     plot.transform(vl.filter({param: "brush"})),
                     //plot.markLine().encode(vl.color(vl.value("red"))),
                 )
                 .data(data)
                 .params(
                     [{name: "start", value: 10,
                       bind: {"input": "range", "min": 10, "max": 21, "step": 1}},
                      {name: "target", value: 22,
                       bind: {"input": "range", "min": 11, "max": 22, "step": 1}},
                      {name: "numbins", value: 200,
                       bind: {"input": "range", "min": 100, "max": 1000, "step": 1}},
                     ]
                 )
                 .transform(
                     vl.filter("datum.start == start"),
                     vl.filter("datum.target == target"),
                 )

             //var runtime = vega.parse(vegaLite.compile(layers.toObject()).spec);

             /* var view = new vega.View(runtime)
              *                    .logLevel(vega.Warn) // set view logging level
              *                    .renderer('canvas')     // set render type (defaults to 'canvas')
              *                    .initialize(document.querySelector('#view')) // set parent DOM element
              *                    .tooltip(new vegaTooltip.Handler().call)
              *                    .hover();            // enable hover event processing, *only call once*!

              * view.runAsync(); // evaluate and render the view */

             vegaEmbed('#view', layers.toObject(), {renderer: "svg"});

             /* VegaDeckGl.use(vega, deck, deck, luma);
              * var view = new VegaDeckGl.ViewGl(runtime)
              *                    .logLevel(vega.Warn) // set view logging level
              *                    .renderer('canvas')     // set render type (defaults to 'canvas')
              *                    .initialize(document.querySelector('#view')) // set parent DOM element
              *                    .tooltip(new vegaTooltip.Handler().call)
              *                    .hover();            // enable hover event processing, *only call once*!

              * view.run(); // evaluate and render the view */
         }).catch(err => {console.log(err);});
     });
    </script>
    <body>
        <p id="test"></p>
        <div id="text"> Note: Suffixes indicating magnitude are actually SI prefixes, i.e. "G" (giga) is used to denote billions.</div>
        <div id="view" style="width:75%;height:75%;"></div>
        <p>
    </body>
</html>
