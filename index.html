<meta charset="utf8" />
<html>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.4.0/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite-api"></script>
    <script>
     var config = {
         locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.4.0/dist/${filename}`
     }
     initSqlJs(config).then(function (SQL) {
         const dataPromise = fetch("https://rationalis.github.io/maplestory-starforce-calc/output.db").then(res => res.arrayBuffer());
         dataPromise.then((buf) => {
             const db = new SQL.Database(new Uint8Array(buf));
             var stmt = db.prepare("SELECT * FROM data");
             stmt.getAsObject({$start:1, $end:1}); // {col1:1, col2:111}

             var data = [];
             // Bind new values
             stmt.bind({$start:1, $end:2});
             while(stmt.step()) { //
                 var row = stmt.getAsObject();
                 data.push(row);
             }

             const plot = vl.markBar()
                            .autosize('fit')
                            .width('container')
                            .height('container')
                            //.transform(vl.density().density("cost").cumulative(true))
                            .encode(
                                vl.x().fieldQ("cost")
                                  .bin(
                                      {maxbins: 200,
                                       nice:false,})
                                  .title("Meso Cost"),
                                vl.y().fieldQ("prob").aggregate("sum").title("Probability"),
                                vl.tooltip([
                                    {field: "cost", type: "quantitative",
                                     bin: {maxbins: 200, nice:false},
                                     format: ".3s", "title": "Cost"},
                                    {field: "prob", type: "quantitative", aggregate: "sum", format: ".3%", "title": "Probability"},
                                ]),
                            )
             ;

             const plot_brush = plot
                 .encode(vl.opacity(vl.value(0.5)))
                 .params([
                     {"name": "brush",
                      "select": {"type": "point", "encodings": ["x"],
                                 "on": {"type": "mousemove", "throttle": "50"},
                                 'nearest': true,
                                 'resolve': 'union'}},

                     /* {"name": "grid",
                      *  "select": "interval",
                      *  "encodings": ["x"],
                      *  "bind": "scales",
                      *  "throttle": 500,
                      * } */
                 ])
             ;

             const density = vl.markLine()
                               .autosize('fit')
                               .width('container')
                               .height('container')
                               .transform(vl.density().density("cost").cumulative(true))
                               .encode(
                                   vl.x().fieldQ("value"),
                                   vl.y().fieldQ("density"),
                                   /* vl.tooltip([
                                    *     //{field: "cost", type: "quantitative", bin: {maxbins: 200}, format: ".3s"},
                                    *     {field: "cdf", type: "quantitative", format: ".2%"},
                                    * ]), */
                                   vl.color(vl.value("red"))
                               )

             const hover = vl.selectSingle()
                             .encodings('x')  // limit selection to x-axis value
                             .on('mouseover') // select on mouseover events
                             .nearest(true)   // select data point nearest the cursor
                             .empty('none');  // empty selection includes no data points

             const density2 = vl.layer(density,
                                       density.markCircle()
                                              //.select(hover) // use as anchor points for selection
                                              //.encode(vl.opacity().if(hover, vl.value(1)).value(0)),
                                              .transform(vl.filter({param: "brush"}))
             )
                                       // add white stroked text to provide a legible background for labels
                                       //base.markText(label, white).encode(vl.text().fieldQ('price')),
                                       // add text labels for stock prices
                                       //base.markText(label).encode(vl.text().fieldQ('price'))

             const histo = vl.layer(plot_brush,
                                    plot.transform(vl.filter({param: "brush"})))


             const layers = vl
                 .layer(
                     histo,
                     density2,
                 )
                 .data(data)
                 .params(
                     [{name: "start", value: 10,
                       bind: {"input": "range", "min": 10, "max": 21, "step": 1}},
                      {name: "target", value: 22,
                       bind: {"input": "range", "min": 11, "max": 22, "step": 1}},
                      {name: "numbins", value: 200,
                       bind: {"input": "range", "min": 100, "max": 1000, "step": 1}},
                     ]
                 )
                 .transform(
                     vl.filter("datum.start == start"),
                     vl.filter("datum.target == target"),
                 )
                 .resolve({scale: {y: "independent"}})

             vegaEmbed('#view', layers.toObject(), {renderer: "svg"});
         }).catch(err => {console.log(err);});
     });
    </script>
    <body>
        <p id="test"></p>
        <div id="text"> Note: Suffixes indicating magnitude are actually SI prefixes, i.e. "G" (giga) is used to denote billions.</div>
        <div id="view" style="width:75%;height:75%;"></div>
        <p>
    </body>
</html>
