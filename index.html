<meta charset="utf8" />
<html>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.4.0/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite-api"></script>

    <script>
     var config = {
         locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.4.0/dist/${filename}`
     }
     initSqlJs(config).then(function (SQL) {
         const dataPromise = fetch("https://rationalis.github.io/maplestory-starforce-calc/output.db").then(res => res.arrayBuffer());
         dataPromise.then((buf) => {
             const db = new SQL.Database(new Uint8Array(buf));
             var stmt = db.prepare("SELECT * FROM data");
             stmt.getAsObject({$start:1, $end:1}); // {col1:1, col2:111}

             var data = [];
             // Bind new values
             stmt.bind({$start:1, $end:2});
             while(stmt.step()) { //
                 var row = stmt.getAsObject();
                 data.push(row);
                 // out += JSON.stringify(row);
             }
             /*              document.getElementById("test").innerHTML = JSON.stringify(data); */

             var spec = vl.markBar()
                          .autosize('fit')
                          .width('container')
                          .height('container')
                          .data(data)
                          .params(
                              [{name: "start", value: 10,
                                bind: {"input": "range", "min": 10, "max": 21, "step": 1}},
                               {name: "target", value: 22,
                                bind: {"input": "range", "min": 11, "max": 22, "step": 1}},
                               {name: "numbins", value: 200,
                                bind: {"input": "range", "min": 100, "max": 1000, "step": 1}},
                               {name: "index",
                                select: {
                                    type: "point",
                                    encodings: ["x"],
                                    on: "mousemove",
                                    nearest: true
                               }},
                              ]
                          )
                          .transform(
                              vl.filter("datum.start == start"),
                              vl.filter("datum.target == target"),
                          )
                          .encode(
                              vl.x().fieldQ("cost").bin({maxbins: 200}).title("Meso Cost"),
                              vl.y().fieldQ("prob").aggregate("sum").title("Probability"),
                              vl.tooltip([
                                  {field: "cost", type: "quantitative", bin: {maxbins: 200}, format: ".2s"},
                                  {field: "prob", type: "quantitative", aggregate: "sum", format: ".4%", "title": "Probability"},
                              ]),
                          )
                          .toObject();
             vegaEmbed('#view', spec, {renderer: "canvas"});
         }).catch(err => {console.log(err);});
     });
    </script>
    <body>
        <p id="test"></p>
        <div id="text"> Note: Suffixes indicating magnitude are actually SI prefixes, i.e. "G" (giga) is used to denote billions.</div>
        <div id="view" style="width:50%;height:50%;"></div>
        <p>
    </body>
</html>
